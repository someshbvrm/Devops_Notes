
---

# üê≥ **Dockerfile Best Practices**

### ‚úÖ **General Guidelines**

* üì¶ **Use official base images** whenever possible
* üèó **Use base images** instead of building from scratch
* üíæ **Add files to volumes** instead of embedding them in images
* üîÑ **Use multi-stage Dockerfile** to reduce image size
* üîç **Scan images** before pushing to registry
* üìÇ **Prefer `COPY` over `ADD`** for transparency and efficiency
* üö´ **Use `.dockerignore`** to avoid copying unnecessary files
* üîí **Avoid sensitive data** in images (credentials, certificates)
* ‚ö† **Avoid running as root** or giving unnecessary privileges
* ‚¨Ü **Update images frequently** to patch vulnerabilities
* üåê **Expose only necessary ports**
* üì¶ **Install only required packages**
* üîó **Use pipes in RUN commands** for efficiency

```dockerfile
RUN wget -O - https://some.site | wc -l > /number
```

---

# üèó **Multi-Stage Dockerfiles**

### **Why Use Multi-Stage Builds**

* Reduce final image size
* Keep **build and runtime environments separate**
* Avoid including unnecessary build artifacts in the final image
* Use multiple `FROM` statements, copying only what‚Äôs needed

---

### **Basic Multi-Stage Dockerfile Example**

```dockerfile
# Stage 0 - Build
FROM golang:1.24
WORKDIR /src

COPY <<EOF ./main.go
package main

import "fmt"

func main() {
  fmt.Println("hello, world")
}
EOF

RUN go build -o /bin/hello ./main.go

# Stage 1 - Final minimal image
FROM scratch
COPY --from=0 /bin/hello /bin/hello
CMD ["/bin/hello"]
```

> üí° **Note:**
>
> * First stage is referred to as `0`, second as `1`, and so on
> * Better readability if you use **named stages**

---

### **Using Stage Names**

```dockerfile
# Stage 1 - Build
FROM golang:1.24 AS build
WORKDIR /src
COPY <<EOF /src/main.go
package main

import "fmt"

func main() {
  fmt.Println("hello, world")
}
EOF
RUN go build -o /bin/hello ./main.go

# Stage 2 - Final
FROM scratch
COPY --from=build /bin/hello /bin/hello
CMD ["/bin/hello"]
```

> üìå **Note:** If `AS build` is omitted, stages default to `0, 1, 2...`

---

# ‚òï **Java Spring Boot Multi-Stage Dockerfile**

```dockerfile
# Stage 1 - Build
FROM maven:3.6.3-adoptopenjdk-11 as stage1
ENV MAVEN_OPTS="-XX:+TieredCompilation -XX:TieredStopAtLevel=1"
WORKDIR /opt/demo

# Copy and cache dependencies
COPY pom.xml .
RUN mvn dependency:go-offline

# Copy source and build jar
COPY ./src ./src
RUN mvn clean install -Dmaven.test.skip=true

# Stage 2 - Runtime
FROM adoptopenjdk/openjdk11:jre-11.0.9_11-alpine
WORKDIR /opt/demo
COPY --from=stage1 /opt/demo/target/demo.jar /opt/demo
```

> ‚ö° **Tip:**
>
> * Stage 1: Build environment (Maven + JDK)
> * Stage 2: Runtime environment (JRE only)
> * Keeps final image lightweight

---

# üîó **References**

* [Docker Multi-Stage Builds](https://docs.docker.com/build/building/multi-stage/#use-multi-stage-builds)
* [Spring Boot Dockerfile Example](https://codefresh.io/docs/docs/example-catalog/ci-examples/spring-boot-2/)
* [Dockerfile Best Practices](https://docs.docker.com/build/building/best-practices/)
* [Sysdig Blog on Best Practices](https://sysdig.com/blog/dockerfile-best-practices)

---

üí° **Assignment:** Create Dockerfiles for the following:

* Spring Boot
* Tomcat
* Node.js
* .NET
* Python

---

