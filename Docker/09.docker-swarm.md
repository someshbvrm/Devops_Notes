
---

# üê≥ **Docker Swarm**

Docker Swarm is a **native clustering and orchestration tool** in Docker that turns a group of Docker hosts (physical or virtual machines) into a **single, unified virtual system**.

---

## üîå **Required Ports**

For Docker Swarm manager and worker communication, open the following ports:

| Port | Purpose                               |
| ---- | ------------------------------------- |
| 2376 | TLS communication (Docker API)        |
| 2377 | Swarm manager cluster communication   |
| 7946 | Container network discovery (TCP/UDP) |
| 4789 | Overlay network (VXLAN)               |

---

## üèó **Swarm Components**

1. **Manager Node** ‚Äì Orchestrates and manages swarm (schedules services).
2. **Worker Node(s)** ‚Äì Execute tasks assigned by the manager.

---

## ‚öô **Swarm Setup (2 Nodes Example)**

### **Step 1: Install Docker**

Install Docker on all machines.

```bash
sudo apt update
sudo apt install docker.io -y
sudo systemctl enable docker
sudo systemctl start docker
```

### **Step 2: Initialize Swarm on Manager**

```bash
sudo docker swarm init
```

> ‚úÖ The first machine becomes the **manager** and generates a `docker swarm join` token.

### **Step 3: Join Worker Nodes**

On each worker node, run:

```bash
docker swarm join --token <worker-token> <manager-ip>:2377
```

---

# ‚ö° **Docker Services**

In Swarm, we **don‚Äôt create individual containers**. Instead, we create **services**.

### **Create a Service**

```bash
docker service create \
  --name mytomcatservice \
  --replicas 6 \
  -p 8080:8080 \
  tomcat:latest
```

* `--replicas` = Number of container instances
* `-p` = Port mapping (host\:container)

### **View Services**

```bash
docker service ls
```

### **Scale Service**

```bash
docker service scale mytomcatservice=8  # Increase replicas
docker service scale mytomcatservice=4  # Decrease replicas
```

---

# üóÇ **Docker Stack**

A **stack** is a **group of multiple services** deployed together.

* Useful for applications with multiple microservices
* Example: An app with 12 microservices ‚Üí create 1 stack, 12 services, replicas 2 each ‚Üí total 24 containers

### **Deploy a Stack**

```bash
docker stack deploy -c mystack.yaml nameofstack
```

> `-c` = Compose file

---

## üìù **Example: Voting App Stack**

```yaml
version: "3.9"

services:
  redis:
    image: redis:alpine
    networks:
      - frontend

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - backend

  vote:
    image: dockersamples/examplevotingapp_vote
    ports:
      - 8080:80
    networks:
      - frontend
    deploy:
      replicas: 2

  result:
    image: dockersamples/examplevotingapp_result
    ports:
      - 8081:80
    networks:
      - backend

  worker:
    image: dockersamples/examplevotingapp_worker
    networks:
      - frontend
      - backend
    deploy:
      replicas: 2

networks:
  frontend:
  backend:

volumes:
  db-data:
```

---

### **üìù Blueprint**

```yaml
Stack.yaml

Service1:
  Replicas: n

Service2:
  Replicas: n
```

---

## üîó **References**

* [Docker Voting App Example](https://github.com/dockersamples/example-voting-app)

---

üí° **Notes / Best Practices**

* Always use a **manager node** to deploy stacks
* Workers handle the **execution of tasks** only
* Use **overlay networks** for inter-service communication across multiple hosts
* Monitor services: `docker service ps <service-name>`
* Remove stack: `docker stack rm <stack-name>`

---

