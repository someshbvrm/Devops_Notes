
---

# â˜ï¸ Amazon EKS RBAC & Troubleshooting Guide

Amazon **Elastic Kubernetes Service (EKS)** integrates **AWS IAM authentication** with **Kubernetes RBAC authorization**.

---

## ğŸ” Authentication vs Authorization in EKS

* **IAM (Authentication)**

  * Determines **who can access** the EKS cluster.
  * Example: IAM Users, Roles, Groups.
  * Configured in `aws-auth` ConfigMap.

* **RBAC (Authorization)**

  * Determines **what actions you can perform** once inside the cluster.
  * Example: Pod access, Secret access, Cluster-wide permissions.

ğŸ‘‰ Both **must work together** in EKS.

---

## ğŸŸ¢ IAM + RBAC Mapping

ğŸ“Œ EKS uses the `aws-auth` ConfigMap to map IAM identities to Kubernetes users/groups.

ğŸ“‚ `aws-auth ConfigMap` (in `kube-system` namespace):

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
data:
  mapRoles: |
    - rolearn: arn:aws:iam::111122223333:role/EKSNodeInstanceRole
      username: system:node:{{EC2PrivateDNSName}}
      groups:
        - system:bootstrappers
        - system:nodes
  mapUsers: |
    - userarn: arn:aws:iam::111122223333:user/dev-user
      username: dev-user
      groups:
        - dev-group
```

ğŸ”¹ After mapping, you use **RBAC Roles/ClusterRoles + Bindings** to grant permissions.

---

## ğŸ“ RBAC in EKS

RBAC works **same as standard Kubernetes**, but IAM identity â†’ mapped to K8s user/group.

---

### Example â€“ Role (Namespace-scoped)

ğŸ“‚ `access/pod-reader-role.yaml`

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: dev
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
```

---

### Example â€“ RoleBinding (Bind Role to IAM User)

ğŸ“‚ `access/pod-reader-rolebinding.yaml`

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-reader-binding
  namespace: dev
subjects:
- kind: User
  name: dev-user                  # from aws-auth ConfigMap
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

---

### Example â€“ ClusterRole & ClusterRoleBinding

ğŸ“‚ `access/secret-reader-clusterrole.yaml`

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-reader
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch"]
```

ğŸ“‚ `access/secret-reader-clusterrolebinding.yaml`

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: secret-reader-binding
subjects:
- kind: Group
  name: dev-group                # from aws-auth ConfigMap
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io
```

---

# ğŸ› ï¸ EKS Troubleshooting Guide

When debugging EKS, follow this order:

ğŸ”¹ **Step 1 â€“ IAM** (authentication)

* Does the IAM user/role exist?
* Is it mapped in `aws-auth` ConfigMap?
* Run:

  ```bash
  kubectl auth can-i get pods --as=dev-user
  ```

---

ğŸ”¹ **Step 2 â€“ RBAC** (authorization)

* Is there a **Role/ClusterRole**?
* Is there a **RoleBinding/ClusterRoleBinding**?
* Test permissions:

  ```bash
  kubectl auth can-i list secrets --as=dev-user -n dev
  ```

---

ğŸ”¹ **Step 3 â€“ Pods**

```bash
kubectl get pods -n <namespace>
kubectl describe pod <pod-name> -n <namespace>
kubectl logs <pod-name>
```

---

ğŸ”¹ **Step 4 â€“ Services**

```bash
kubectl get svc <service-name> -n <namespace>
kubectl describe svc <service-name> -n <namespace>
kubectl get endpoints <service-name> -n <namespace>
```

âš¡ Check:

* Service type (`ClusterIP`, `NodePort`, `LoadBalancer`)
* Endpoints exist?

---

ğŸ”¹ **Step 5 â€“ Ingress**

* Is the **ALB Ingress Controller** (or NGINX Ingress Controller) running?
* Logs:

  ```bash
  kubectl logs -n kube-system <alb-ingress-controller-pod>
  ```
* Validate DNS â†’ ALB â†’ Service â†’ Pod chain.

---

ğŸ”¹ **Step 6 â€“ Networking**

* ğŸ” Check **Security Groups** (EKS worker nodes + Load Balancer).
* ğŸ” Check **Network Policies**.
* ğŸŒ Validate routing in **VPC / Subnets / NACLs**.

---

# âš¡ Quick Checklist

âœ… IAM role/user exists and mapped in `aws-auth`
âœ… Correct RBAC Role/ClusterRole assigned
âœ… Pods running (`kubectl get pods`)
âœ… Service has endpoints
âœ… Ingress is resolving + ALB working
âœ… Network path (SG, NACL, VPC) is open

---
